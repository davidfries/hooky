<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hooky</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6VKHr8zWv1pGp9l9huZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="theme.css">
</head>
<body>
  <header class="navbar navbar-expand-lg navbar-dark app-navbar">
    <div class="container container-narrow d-flex align-items-center gap-3">
      <a class="navbar-brand brand" href="/"><span class="logo"></span> Hooky</a>
      <div class="controls d-flex align-items-center gap-2 ms-auto">
        <input id="ttl" class="form-control w-auto" type="number" min="10" step="10" placeholder="TTL seconds (default 3600)" />
        <button id="create" class="btn btn-primary">Create endpoint</button>
        <button id="theme" class="btn btn-outline-secondary" title="Toggle theme">ðŸŒ“</button>
      </div>
    </div>
  </header>
  <main class="container container-narrow py-4">
    <div class="row g-3">
      <aside class="col-md-3 col-lg-3 border-end p-3">
        <div class="muted mb-2">Active endpoints</div>
        <div id="list" class="list list-group"></div>
      </aside>
      <section class="col-md-9 col-lg-9 p-3">
        <div id="detail" class="mb-4 detail-card"></div>
        <div class="d-flex align-items-center mb-3">
          <h3 class="mb-0 d-flex align-items-center gap-2">Events <span id="live-indicator" class="live-pill"><span class="live-dot"></span><span id="live-label">Live</span></span></h3>
          <div class="d-flex gap-2 flex-wrap align-items-center ms-auto">
            <select id="filter-method" class="form-select">
            <option value="">All methods</option>
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>PATCH</option>
            <option>DELETE</option>
            <option>HEAD</option>
            <option>OPTIONS</option>
            </select>
            <input id="filter-text" class="form-control" type="text" placeholder="Search (path, headers, body)" />
            <button id="clear-filters" class="btn btn-outline-secondary" title="Clear filters">Clear</button>
            <button id="compare-btn" class="btn btn-primary" disabled title="Compare selected">Compare</button>
          </div>
        </div>
        <div class="stream-wrap">
        <div id="diff-panel" class="card mt-4 d-none">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <strong>Diff</strong>
              <div class="d-flex gap-2 ms-auto">
                <button id="copy-diff" class="btn btn-outline-secondary" title="Copy diff">Copy Diff</button>
                <button id="close-diff" class="btn btn-outline-secondary" title="Close">Close</button>
              </div>
            </div>
            <pre id="diff-output" class="diff"></pre>
          </div>
        </div>
        <div id="events" class="events mt-3"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const API = '';
    const listEl = document.getElementById('list');
    const detailEl = document.getElementById('detail');
    const eventsEl = document.getElementById('events');
    const createBtn = document.getElementById('create');
    const ttlInput = document.getElementById('ttl');
    const themeBtn = document.getElementById('theme');
    const filterMethod = document.getElementById('filter-method');
    const filterText = document.getElementById('filter-text');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const compareBtn = document.getElementById('compare-btn');
    const diffPanel = document.getElementById('diff-panel');
    const diffOutput = document.getElementById('diff-output');
    const copyDiffBtn = document.getElementById('copy-diff');
    const closeDiffBtn = document.getElementById('close-diff');
    const liveIndicator = document.getElementById('live-indicator');
    const liveLabel = document.getElementById('live-label');

    let currentId = null;
    let es = null;
    let rawEvents = [];
    let selectedEventIds = new Set();
    let liveEnabled = true;

    // Theme handling
    function setTheme(t) {
      document.body.setAttribute('data-theme', t);
      localStorage.setItem('hooky:theme', t);
    }
    const savedTheme = localStorage.getItem('hooky:theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    setTheme(savedTheme);
    themeBtn.onclick = () => {
      const cur = document.body.getAttribute('data-theme') || 'dark';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    };

    // Copy helper
    async function copy(text) {
      try { await navigator.clipboard.writeText(text); } catch (e) { console.warn('Clipboard failed', e); }
    }

    // JSON viewer (collapsible)
    function renderJSON(value) {
      const container = document.createElement('div');
      container.className = 'json';
      container.appendChild(renderNode(value));
      return container;
    }
    function renderNode(val, key) {
      const el = document.createElement('div');
      if (val === null) {
        el.innerHTML = key != null ? `<span class="key">"${key}"</span>: <span class="null">null</span>` : `<span class="null">null</span>`;
        return el;
      }
      const t = typeof val;
      if (t === 'string') {
        el.innerHTML = key != null ? `<span class="key">"${key}"</span>: <span class="string">"${escapeHtml(val)}"</span>` : `<span class="string">"${escapeHtml(val)}"</span>`;
        return el;
      }
      if (t === 'number') {
        el.innerHTML = key != null ? `<span class="key">"${key}"</span>: <span class="number">${val}</span>` : `<span class="number">${val}</span>`;
        return el;
      }
      if (t === 'boolean') {
        el.innerHTML = key != null ? `<span class="key">"${key}"</span>: <span class="boolean">${val}</span>` : `<span class="boolean">${val}</span>`;
        return el;
      }
      if (Array.isArray(val)) {
        const summary = document.createElement('div');
        const body = document.createElement('div');
        body.className = 'kv';
        let open = false;
        const update = () => { summary.innerHTML = `<span class="toggle">${open ? 'â–¼' : 'â–¶'}</span> ${key != null ? `<span class="key">"${key}"</span>: ` : ''}[array ${val.length}]`; body.style.display = open ? 'block' : 'none'; };
        summary.onclick = () => { open = !open; update(); };
        update();
        val.forEach((item, idx) => body.appendChild(renderNode(item, idx)));
        el.appendChild(summary); el.appendChild(body); return el;
      }
      if (t === 'object') {
        const keys = Object.keys(val);
        const summary = document.createElement('div');
        const body = document.createElement('div');
        body.className = 'kv';
        let open = false;
        const update = () => { summary.innerHTML = `<span class="toggle">${open ? 'â–¼' : 'â–¶'}</span> ${key != null ? `<span class="key">"${key}"</span>: ` : ''}{object ${keys.length}}`; body.style.display = open ? 'block' : 'none'; };
        summary.onclick = () => { open = !open; update(); };
        update();
        keys.forEach(k => body.appendChild(renderNode(val[k], k)));
        el.appendChild(summary); el.appendChild(body); return el;
      }
      el.textContent = String(val);
      return el;
    }
    function escapeHtml(s){ return s.replace(/[&<>"]|'/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function fmtTime(ms) {
      const s = Math.max(0, Math.round((ms - Date.now()) / 1000));
      return s + 's';
    }

    async function loadList() {
      try {
        const res = await fetch(API + '/api/endpoints');
        if (!res.ok) throw new Error('Failed to load endpoints');
        const data = await res.json();
        listEl.innerHTML = '';
        if (!data.endpoints.length) {
          const empty = document.createElement('div');
          empty.className = 'muted text-center';
          empty.textContent = 'No endpoints yet. Create one.';
          listEl.appendChild(empty);
          return;
        }
        for (const ep of data.endpoints) {
          const div = document.createElement('div');
          div.className = 'ep list-group-item list-group-item-action' + (ep.id === currentId ? ' active' : '');
          div.dataset.epId = ep.id;
            div.innerHTML = `<div class="d-flex justify-content-between"><strong>${ep.id}</strong><span class="muted">${fmtTime(ep.expiresAt)}</span></div><div class="muted text-break">${ep.url}</div><div class="d-flex justify-content-between align-items-center"><div class="muted">events: <span class="ep-count">${ep.eventCount}</span></div><button class="btn btn-sm btn-outline-danger delete-ep" data-id="${ep.id}" title="Delete endpoint" onclick="event.stopPropagation()">Delete</button></div>`;
          div.onclick = () => select(ep.id, ep.url, ep.expiresAt);
          listEl.appendChild(div);
        }
        // Attach delete handlers
        listEl.querySelectorAll('.delete-ep').forEach(btn => {
          btn.onclick = async (e) => {
            e.stopPropagation();
            const id = btn.dataset.id;
            if (!confirm(`Delete endpoint ${id}? This will remove all events.`)) return;
            await deleteEndpoint(id);
          };
        });
      } catch (err) {
        listEl.innerHTML = '<div class="muted">Error loading endpoints</div>';
        console.error(err);
      }
    }

    async function select(id, url, expiresAt) {
      currentId = id;
      detailEl.innerHTML = `<div class="card glass p-5 text-center"><div class="mb-3"><strong>${id}</strong> <span class="pill">${fmtTime(expiresAt)} left</span></div><div class="d-flex flex-wrap justify-content-center gap-3 mb-4"><button id="copy-id" class="btn btn-outline-secondary" title="Copy ID">Copy ID</button><button id="copy-url" class="btn btn-outline-secondary" title="Copy URL">Copy URL</button><button id="toggle-live" class="btn btn-outline-secondary" title="Toggle live">${liveEnabled ? 'Pause Live' : 'Resume Live'}</button><button id="delete-endpoint" class="btn btn-outline-danger" title="Delete endpoint">Delete</button></div><div class="wrap"><a href="${url}" target="_blank">${url}</a></div></div>`;
      setActiveEndpointCard(id);
      document.getElementById('copy-id').onclick = () => copy(id);
      document.getElementById('copy-url').onclick = () => copy(url);
      document.getElementById('delete-endpoint').onclick = async () => {
        if (!confirm(`Delete endpoint ${id}? This will remove all events.`)) return;
        await deleteEndpoint(id);
      };
      document.getElementById('toggle-live').onclick = () => {
        liveEnabled = !liveEnabled;
        liveLabel.textContent = liveEnabled ? 'Live' : 'Paused';
        document.getElementById('toggle-live').textContent = liveEnabled ? 'Pause Live' : 'Resume Live';
      };
      eventsEl.innerHTML = '';
      if (es) { es.close(); es = null; }
      const res = await fetch(API + `/api/endpoints/${id}/events`);
      const data = await res.json();
      rawEvents = data.events.slice();
      renderEvents();
      es = new EventSource(API + `/api/endpoints/${id}/stream`);
      const onWebhook = (ev) => {
        try {
          const evt = JSON.parse(ev.data);
          rawEvents.unshift(evt);
          if (liveEnabled) {
            addIncomingEvent(evt);
          }
          updateEndpointEventCount(id);
        } catch (e) { console.warn('Invalid event payload', e); }
      };
      es.addEventListener('webhook', onWebhook);
      es.onopen = () => { liveLabel.textContent = 'Live'; };
      es.onerror = () => {
        console.warn('Stream error; browser will attempt to reconnect');
        liveLabel.textContent = 'Reconnectingâ€¦';
      };
    }

    function renderEvents() {
      eventsEl.innerHTML = '';
      const methodFilter = filterMethod.value.trim().toUpperCase();
      const textFilter = filterText.value.trim().toLowerCase();
      const filtered = rawEvents.filter(evt => {
        if (methodFilter && evt.method !== methodFilter) return false;
        if (textFilter) {
          const haystack = [evt.path, JSON.stringify(evt.headers || {}), typeof evt.body === 'string' ? evt.body : JSON.stringify(evt.body)].join('\n').toLowerCase();
          if (!haystack.includes(textFilter)) return false;
        }
        return true;
      });
      for (const evt of filtered) {
        eventsEl.appendChild(buildEventCard(evt));
      }
      updateCompareState();
    }

    function passesCurrentFilters(evt) {
      const methodFilter = filterMethod.value.trim().toUpperCase();
      const textFilter = filterText.value.trim().toLowerCase();
      if (methodFilter && evt.method !== methodFilter) return false;
      if (textFilter) {
        const haystack = [evt.path, JSON.stringify(evt.headers || {}), typeof evt.body === 'string' ? evt.body : JSON.stringify(evt.body)].join('\n').toLowerCase();
        if (!haystack.includes(textFilter)) return false;
      }
      return true;
    }

    function addIncomingEvent(evt) {
      if (!passesCurrentFilters(evt)) return; // keep but don't show
      const card = buildEventCard(evt);
      card.classList.add('flash');
      eventsEl.prepend(card);
      // Trim DOM list if too large for performance
      if (eventsEl.children.length > 300) {
        eventsEl.removeChild(eventsEl.lastChild);
      }
      updateCompareState();
    }

    function updateEndpointEventCount(id) {
      const card = listEl.querySelector(`.ep[data-ep-id="${id}"] .ep-count`);
      if (card) {
        const current = parseInt(card.textContent || '0', 10) + 1;
        card.textContent = String(current);
      }
    }

    function setActiveEndpointCard(id) {
      listEl.querySelectorAll('.ep').forEach(c => c.classList.toggle('active', c.dataset.epId === id));
    }

    async function deleteEndpoint(id) {
      try {
        const res = await fetch(API + `/api/endpoints/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete endpoint');
        // Close SSE if active
        if (currentId === id) {
          if (es) { es.close(); es = null; }
          currentId = null;
          eventsEl.innerHTML = '';
          detailEl.innerHTML = `<div class="card glass p-5 text-center"><div class="muted mb-2">Create or select an endpoint to view details.</div><div class="small text-muted">Use the TTL field to set a lifespan before creation.</div></div>`;
        }
        await loadList();
      } catch (err) {
        console.error('Delete failed', err);
        alert('Failed to delete endpoint');
      }
    }

    function buildEventCard(evt) {
      const el = document.createElement('div');
      el.className = 'evt card';
      const cardBody = document.createElement('div');
      cardBody.className = 'card-body';
      const headerHtml = document.createElement('div');
      headerHtml.className = 'd-flex justify-content-between';
      headerHtml.innerHTML = `<div><strong>${evt.method}</strong> <span class="muted">${evt.path}</span></div><div class="muted">${new Date(evt.timestamp).toLocaleTimeString()}</div>`;
      const meta = document.createElement('div');
      meta.className = 'd-flex justify-content-between mt-1';
      meta.innerHTML = `<div class="muted">id: ${evt.id}</div><div class="d-flex gap-2"><button class="btn btn-outline-secondary" data-copy="id" title="Copy event id">Copy ID</button><button class="btn btn-outline-primary" data-select="${evt.id}" title="Select for diff">${selectedEventIds.has(evt.id) ? 'Unselect' : 'Select'}</button></div>`;

      const headersSection = document.createElement('div');
      const bodySection = document.createElement('div');
      const headersTitle = document.createElement('div');
      headersTitle.className = 'd-flex justify-content-between align-items-center';
      headersTitle.innerHTML = `<strong>Headers</strong><div class="d-flex gap-2"><button class="btn btn-outline-secondary" title="Copy headers">Copy</button></div>`;
      const bodyTitle = document.createElement('div');
      bodyTitle.className = 'd-flex justify-content-between align-items-center';
      bodyTitle.innerHTML = `<strong>Body</strong><div class="d-flex gap-2"><button class="btn btn-outline-secondary" title="Copy body">Copy</button></div>`;

      const headersView = renderJSON(evt.headers || {});
      let parsedBody = evt.body;
      if (typeof parsedBody === 'string') { try { parsedBody = JSON.parse(parsedBody); } catch {} }
      const bodyView = renderJSON(parsedBody);

      headersSection.appendChild(headersTitle);
      headersSection.appendChild(headersView);
      bodySection.appendChild(bodyTitle);
      bodySection.appendChild(bodyView);

      cardBody.appendChild(headerHtml);
      cardBody.appendChild(meta);
      cardBody.appendChild(headersSection);
      cardBody.appendChild(bodySection);
      el.appendChild(cardBody);

      const [copyHeadersBtn] = headersTitle.querySelectorAll('button');
      const [copyBodyBtn] = bodyTitle.querySelectorAll('button');
      copyHeadersBtn.onclick = () => copy(JSON.stringify(evt.headers || {}, null, 2));
      copyBodyBtn.onclick = () => copy(typeof evt.body === 'string' ? evt.body : JSON.stringify(evt.body, null, 2));
      meta.querySelector('[data-copy="id"]').onclick = () => copy(evt.id);
      meta.querySelector(`[data-select="${evt.id}"]`).onclick = () => toggleSelect(evt.id);
      return el;
    }

    function toggleSelect(id) {
      if (selectedEventIds.has(id)) selectedEventIds.delete(id); else {
        if (selectedEventIds.size >= 2) {
          // replace oldest selection
          selectedEventIds = new Set([...[...selectedEventIds][1], id]);
        } else {
          selectedEventIds.add(id);
        }
      }
      renderEvents();
    }

    function updateCompareState() {
      compareBtn.disabled = selectedEventIds.size !== 2;
    }

    compareBtn.onclick = () => {
      if (selectedEventIds.size !== 2) return;
      const [aId, bId] = [...selectedEventIds];
      const a = rawEvents.find(e => e.id === aId);
      const b = rawEvents.find(e => e.id === bId);
      if (!a || !b) return;
      const diffLines = buildDiff(a, b);
      diffOutput.innerHTML = renderDiffHtml(diffLines);
      diffOutput.dataset.raw = diffLines.join('\n');
      diffPanel.classList.remove('d-none');
    };
    closeDiffBtn.onclick = () => {
      // Clear diff output and selection state
      diffOutput.innerHTML = '';
      diffOutput.removeAttribute('data-raw');
      selectedEventIds = new Set();
      compareBtn.disabled = true;
      // Re-render events to switch buttons back to 'Select'
      renderEvents();
      diffPanel.classList.add('d-none');
    };
    copyDiffBtn.onclick = () => copy(diffOutput.dataset.raw || diffOutput.textContent);

    function flatten(obj, prefix = '', out = {}) {
      if (obj && typeof obj === 'object' && !Array.isArray(obj)) {
        for (const k of Object.keys(obj)) flatten(obj[k], prefix ? prefix + '.' + k : k, out);
      } else if (Array.isArray(obj)) {
        obj.forEach((v, i) => flatten(v, `${prefix}[${i}]`, out));
      } else {
        out[prefix] = obj;
      }
      return out;
    }
    function buildDiff(aEvt, bEvt) {
      const parseBody = (b) => {
        let v = b; if (typeof v === 'string') { try { v = JSON.parse(v); } catch {} } return v;
      };
      const aObj = { headers: aEvt.headers || {}, body: parseBody(aEvt.body) };
      const bObj = { headers: bEvt.headers || {}, body: parseBody(bEvt.body) };
      const aFlat = flatten(aObj);
      const bFlat = flatten(bObj);
      const allKeys = new Set([...Object.keys(aFlat), ...Object.keys(bFlat)]);
      const lines = [];
      for (const key of [...allKeys].sort()) {
        const av = aFlat[key];
        const bv = bFlat[key];
        if (av === undefined && bv !== undefined) lines.push(`+ ${key}: ${JSON.stringify(bv)}`);
        else if (av !== undefined && bv === undefined) lines.push(`- ${key}: ${JSON.stringify(av)}`);
        else if (JSON.stringify(av) !== JSON.stringify(bv)) lines.push(`~ ${key}: ${JSON.stringify(av)} -> ${JSON.stringify(bv)}`);
      }
      if (!lines.length) lines.push('No differences');
      lines.unshift(`Comparing ${aEvt.id} (${aEvt.method}) vs ${bEvt.id} (${bEvt.method})`);
      return lines;
    }

    function renderDiffHtml(lines) {
      return lines.map((line, idx) => {
        let cls = 'diff-line diff-header';
        if (idx > 0) {
          if (line.startsWith('+ ')) cls = 'diff-line diff-add';
          else if (line.startsWith('- ')) cls = 'diff-line diff-remove';
          else if (line.startsWith('~ ')) cls = 'diff-line diff-change';
          else cls = 'diff-line';
        }
        return `<span class="${cls}">${escapeHtml(line)}</span>`;
      }).join('\n');
    }

    filterMethod.onchange = renderEvents;
    filterText.oninput = () => { renderEvents(); };
    clearFiltersBtn.onclick = () => { filterMethod.value=''; filterText.value=''; renderEvents(); };

    createBtn.onclick = async () => {
      const ttlSeconds = ttlInput.value ? Number(ttlInput.value) : undefined;
      const res = await fetch(API + '/api/endpoints', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(ttlSeconds ? { ttlSeconds } : {}) });
      const ep = await res.json();
      await loadList();
      select(ep.id, ep.url, ep.expiresAt);
    };

    // Initial placeholder centered detail card
    detailEl.innerHTML = `<div class=\"card glass p-5 text-center\"><div class=\"muted mb-2\">Create or select an endpoint to view details.</div><div class=\"small text-muted\">Use the TTL field to set a lifespan before creation.</div></div>`;
    loadList();
    setInterval(loadList, 5000);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-qQ2iX+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
</body>
</html>